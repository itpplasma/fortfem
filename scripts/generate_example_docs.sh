#!/bin/bash
set -e

echo "üî® Generating example documentation pages..."
echo "Current directory: $(pwd)"
echo "Available directories:"
ls -la

# Directories
EXAMPLE_DIR="example"
DOC_EXAMPLES_DIR="doc/examples"
ARTIFACTS_DIR="artifacts/plots"
OUTPUT_DIR="$DOC_EXAMPLES_DIR/generated"

# Create output directory
mkdir -p "$OUTPUT_DIR"

# Create index.md for the generated subdirectory
cat > "$OUTPUT_DIR/index.md" << 'EOF'
---
title: Example Source Code
---

# Example Source Code and Plots

This section contains detailed documentation for each FortFEM example, including:
- Complete source code listings
- Generated plots and visualizations
- Usage instructions

[‚Üê Back to Examples](../index.html)
EOF

# Initialize the examples index page
cat > "$DOC_EXAMPLES_DIR/index.md" << 'EOF'
---
title: Examples
---

# FortFEM Examples

This page provides an overview of the example programs included with FortFEM, complete with source code listings and generated plots.

## Running Examples

To run any example:
```bash
fpm run --example <example_name>
```

To list all available examples:
```bash
fpm run --example --list
```

## Available Examples

EOF

# Process each example directory
example_count=0
for example_dir in "$EXAMPLE_DIR"/*/; do
    echo "üîç Checking directory: $example_dir"
    if [[ ! -d "$example_dir" ]]; then
        echo "No example directories found in $EXAMPLE_DIR"
        continue
    fi
    
    example_name=$(basename "$example_dir")
    example_file="$example_dir/${example_name}.f90"
    example_readme="$example_dir/README.md"
    
    echo "üîç Looking for: $example_file"
    if [[ ! -f "$example_file" ]]; then
        echo "‚ö†Ô∏è  No ${example_name}.f90 found in $example_dir, skipping..."
        continue
    fi
    
    echo "üìÑ Processing example: $example_name"
    
    # Create individual example page
    example_doc="$OUTPUT_DIR/${example_name}.md"
    
    # Start building the example page
    cat > "$example_doc" << EOF
---
title: $example_name Example
---

# $example_name Example

EOF
    
    # Add README content if it exists
    if [[ -f "$example_readme" ]]; then
        echo "üìñ Adding README for $example_name"
        cat "$example_readme" >> "$example_doc"
        echo "" >> "$example_doc"
    else
        # Generate basic description from program comment if available
        first_comment=$(grep -m 1 "^[[:space:]]*!" "$example_file" 2>/dev/null | sed 's/^[[:space:]]*![[:space:]]*//' 2>/dev/null || echo "")
        if [[ -n "$first_comment" ]]; then
            echo "$first_comment" >> "$example_doc"
            echo "" >> "$example_doc"
        fi
    fi
    
    # Add usage section
    cat >> "$example_doc" << EOF
## Usage

\`\`\`bash
fpm run --example $example_name
\`\`\`

## Source Code

\`\`\`fortran
EOF
    
    # Add source code with line numbers
    cat "$example_file" >> "$example_doc"
    
    cat >> "$example_doc" << EOF
\`\`\`

## Generated Plots

EOF
    
    # Find and add related plots
    plot_found=false
    unset added_plots
    declare -A added_plots  # Track which plots have been added
    
    if [[ -d "$ARTIFACTS_DIR" ]]; then
        echo "üñºÔ∏è  Looking for plots in $ARTIFACTS_DIR for $example_name"
        
        # Look for plots that match the example name or are generated by it
        for plot_pattern in "${example_name}"*.png "$example_name"_*.png "${example_name/-/_}"*.png; do
            for plot_file in "$ARTIFACTS_DIR"/$plot_pattern; do
                if [[ -f "$plot_file" ]]; then
                    plot_name=$(basename "$plot_file")
                    
                    # Skip if already added
                    if [[ -n "${added_plots[$plot_name]}" ]]; then
                        continue
                    fi
                    added_plots[$plot_name]=1
                    
                    rel_plot_path="../../../artifacts/plots/$plot_name"
                    echo "  Found plot: $plot_name"
                    
                    cat >> "$example_doc" << EOF
### $plot_name

![${plot_name}](${rel_plot_path})

EOF
                    plot_found=true
                fi
            done
        done
        
        # Also look for generic patterns based on example type
        case "$example_name" in
            plot_mesh)
                # For plot_mesh example, include all mesh plots
                for plot_file in "$ARTIFACTS_DIR"/mesh*.png; do
                    if [[ -f "$plot_file" ]]; then
                        plot_name=$(basename "$plot_file")
                        
                        # Skip if already added
                        if [[ -n "${added_plots[$plot_name]}" ]]; then
                            continue
                        fi
                        added_plots[$plot_name]=1
                        
                        rel_plot_path="../../../artifacts/plots/$plot_name"
                        echo "  Found related plot: $plot_name"
                        
                        cat >> "$example_doc" << EOF
### $plot_name

![${plot_name}](${rel_plot_path})

EOF
                        plot_found=true
                    fi
                done
                ;;
            *plotting*)
                # For the plotting example, include all demonstration plots
                for plot_file in "$ARTIFACTS_DIR"/solution_*.png "$ARTIFACTS_DIR"/test_mesh*.png; do
                    if [[ -f "$plot_file" ]]; then
                        plot_name=$(basename "$plot_file")
                        
                        # Skip if already added
                        if [[ -n "${added_plots[$plot_name]}" ]]; then
                            continue
                        fi
                        added_plots[$plot_name]=1
                        
                        rel_plot_path="../../../artifacts/plots/$plot_name"
                        echo "  Found related plot: $plot_name"
                        
                        cat >> "$example_doc" << EOF
### $plot_name

![${plot_name}](${rel_plot_path})

EOF
                        plot_found=true
                    fi
                done
                ;;
            *poisson*)
                for plot_file in "$ARTIFACTS_DIR"/poisson*.png "$ARTIFACTS_DIR"/mesh*.png; do
                    if [[ -f "$plot_file" ]]; then
                        plot_name=$(basename "$plot_file")
                        
                        # Skip if already added
                        if [[ -n "${added_plots[$plot_name]}" ]]; then
                            continue
                        fi
                        added_plots[$plot_name]=1
                        
                        rel_plot_path="../../../artifacts/plots/$plot_name"
                        echo "  Found related plot: $plot_name"
                        
                        cat >> "$example_doc" << EOF
### $plot_name

![${plot_name}](${rel_plot_path})

EOF
                        plot_found=true
                    fi
                done
                ;;
            *curl*)
                for plot_file in "$ARTIFACTS_DIR"/curl*.png "$ARTIFACTS_DIR"/curlcurl*.png; do
                    if [[ -f "$plot_file" ]]; then
                        plot_name=$(basename "$plot_file")
                        
                        # Skip if already added
                        if [[ -n "${added_plots[$plot_name]}" ]]; then
                            continue
                        fi
                        added_plots[$plot_name]=1
                        
                        rel_plot_path="../../../artifacts/plots/$plot_name"
                        echo "  Found related plot: $plot_name"
                        
                        cat >> "$example_doc" << EOF
### $plot_name

![${plot_name}](${rel_plot_path})

EOF
                        plot_found=true
                    fi
                done
                ;;
            *mesh*)
                for plot_file in "$ARTIFACTS_DIR"/mesh*.png; do
                    if [[ -f "$plot_file" ]]; then
                        plot_name=$(basename "$plot_file")
                        
                        # Skip if already added
                        if [[ -n "${added_plots[$plot_name]}" ]]; then
                            continue
                        fi
                        added_plots[$plot_name]=1
                        
                        rel_plot_path="../../../artifacts/plots/$plot_name"
                        echo "  Found related plot: $plot_name"
                        
                        cat >> "$example_doc" << EOF
### $plot_name

![${plot_name}](${rel_plot_path})

EOF
                        plot_found=true
                    fi
                done
                ;;
        esac
    fi
    
    if [[ "$plot_found" == false ]]; then
        echo "  No plots found for $example_name"
        cat >> "$example_doc" << EOF
*No plots available for this example.*

EOF
    fi
    
    # Add footer
    cat >> "$example_doc" << EOF

---

[‚Üê Back to Examples](../index.html) | [FortFEM Documentation](../../index.html)
EOF
    
    # Add to examples index
    echo "  Adding to index..."
    example_description=$(head -n 20 "$example_file" 2>/dev/null | grep -m 1 "^[[:space:]]*!" 2>/dev/null | sed 's/^[[:space:]]*![[:space:]]*//' 2>/dev/null || echo "Example program")
    cat >> "$DOC_EXAMPLES_DIR/index.md" << EOF
- [$example_name](generated/${example_name}.html) - $example_description
EOF
    
    # Also add to generated subdirectory index
    cat >> "$OUTPUT_DIR/index.md" << EOF
- [$example_name](${example_name}.html) - $example_description
EOF
    
    echo "  ‚úÖ Completed processing $example_name"
    example_count=$((example_count + 1))
    echo "üîç Moving to next example..."
done

echo "üîç Loop completed. Found $example_count examples total."

echo "üìù Processing complete, finalizing index..."

# Complete the examples index
echo "üìù Adding final sections to index file..."
cat >> "$DOC_EXAMPLES_DIR/index.md" << 'EOF'

## Creating Your Own Examples

To create a new example:

1. Create a new file in `example/` directory
2. Follow the minimal FEniCS-style pattern
3. Optionally create a `<example_name>_README.md` file for detailed documentation

## Visualization

FortFEM provides built-in plotting via fortplotlib:

```fortran
! Scalar field plotting
call plot(uh, filename="solution.png", plot_title="Poisson Solution", colormap="viridis")

! Vector field plotting  
call plot(Eh, filename="field.png", plot_type="streamplot", plot_title="E Field")

! Mesh plotting
call plot(mesh, filename="mesh.png", plot_title="FEM Mesh")
```

Available colormaps: `viridis`, `plasma`, `jet`, `coolwarm`, `hot`, `gray`

---

[‚Üê Back to Documentation](../index.html)
EOF

echo "‚úÖ Generated documentation for $example_count examples"

# Copy plots to documentation directory for FORD
if [[ -d "$ARTIFACTS_DIR" ]]; then
    echo "üìÅ Copying plots to documentation directory..."
    mkdir -p build/doc/artifacts/plots || true
    cp -r "$ARTIFACTS_DIR"/* build/doc/artifacts/plots/ 2>/dev/null || true
    echo "‚úÖ Plots copied to build/doc/artifacts/plots/"
else
    echo "üìÅ No artifacts directory found, skipping plot copy"
fi

echo "üéâ Example documentation generation complete!"